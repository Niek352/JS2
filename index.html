  <!DOCTYPE html>
  <html>
  <head>
  	<meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="style.css">
    <title></title>
  </head>
  <body>
    <header style="margin-bottom: 10px">
      <button id="cart-button" type="button">Корзина <span id="numberOfGoods" ></span></button>

    </header>
    <main style="">
      <div class="goods-list"></div>
      <div class="sum"></div>
      <div class="fullCart" ></div>
      <button id="removeCart" >Отчистить корзину</button>
    </main>
  </body>

<script type="text/javascript">
d = document;
const API_URL = 'https://raw.githubusercontent.com/GeekBrainsTutorial/online-store-api/master/responses';
var cart = {};
var allListOfCart = {};



function makeGETRequest(url) {
	var xhr;
	if (window.XMLHttpRequest) {
	    xhr = new XMLHttpRequest();
	} else if (window.ActiveXObject) { 
	    xhr = new ActiveXObject("Microsoft.XMLHTTP");
  	}

  	xhr.open('GET', url, true);
  	xhr.send();

  	return	new	Promise((resolve, reject) => {
		xhr.onreadystatechange = function () {
		   	if (xhr.readyState === 4){
		    	if (xhr.status === 200) {
		    		resolve(xhr.responseText);
		    	} else {
		    		reject(console.error())
		    	}
		    }		 
		}
	});

}
	



class GoodsItem {
  constructor(title, price, id_product) {
  	this.id_product = id_product;
    this.product_name = title;
    this.price = price;
    
  }
  render() {
    return `<div class="goods-item" >
		        <h3>${this.product_name || 'Товар  отсутствует' }</h3>
		      	<p> ${this.price || 0}</p>
		      	<button  id="${this.id_product}" class="AddGoodsButton" type="button">Добавить</button>      	
      		</div>
      		`;  
	}
   }
class GoodsList {
  constructor() {
    this.goods = [];
  }
  fetchGoods() {
    makeGETRequest(`${API_URL}/catalogData.json`).then((goods) => {
      this.goods = JSON.parse(goods);
      this.render();
      this.addSettings();
      
    });
  }
  render(cb) {
    let listHtml = '';
    this.goods.forEach(good => {
        const goodItem = new GoodsItem(good.product_name, good.price, good.id_product);
        listHtml += goodItem.render();
    });
    d.querySelector('.goods-list').innerHTML = listHtml;
    this.enumerationForAllCart();
  }

  sum(){
  	return this.goods.reduce((totalPrice, good) => {  		
  		if (!good.price) return totalPrice
  		return totalPrice += good.price
  	},0);
  }

  enumerationForAllCart(){
  	this.goods.forEach(function(item){
		var id_product = item.id_product;
		allListOfCart[id_product] = item;
        allListOfCart[id_product].count = 0;	
	})
  }

  addToCart(){
    var idOfProductForCart = this.getAttribute("id");
    cart[idOfProductForCart] = allListOfCart[idOfProductForCart];
    console.log(cart[idOfProductForCart])

    if (cart[idOfProductForCart].count == undefined) {
      cart[idOfProductForCart].count = 1;
    } else {
      cart[idOfProductForCart].count++;
    }

    localStorage.setItem('cart', JSON.stringify(cart));
    renderCart();
  };
  
  addSettings (){
  	d.getElementById("cart-button").addEventListener('click', showGoodsInCart);
  	d.getElementById("removeCart").addEventListener('click', removeCart);
	this.goods.forEach((item) => {
		let a = d.getElementById(item.id_product)
		a.addEventListener('click', this.addToCart)
	});
  };

  renderSum(){
  	let listResult = '';
    listResult += `<h3>${this.sum()}</h3>`;
    d.querySelector('.sum').innerHTML = listResult;
  };
};



function showGoodsInCart() {
    if (d.querySelector('.fullCart').innerHTML == '') {		
        renderCart()
    }  else {
      d.querySelector('.fullCart').innerHTML = '';
    } 
};
function renderCart(){
    var fullCart = d.querySelector('.fullCart');
    
    var out = '';

    for (let key in cart) {
        out += `<div class= "goodInCart">`
        out += `<h3 class= "prNameInCart">${cart[key].product_name}</h3>`
        out += `<p class= "priceInCart">${cart[key].price * cart[key].count}</p>`
        out += `<button class="deleteFromCart" dataminus=${cart[key].id_product}> delete </button>`
        out += `<p class="countInCart">${cart[key].count}</p>`
        out += `<button class="addOneMoreToCart" data=${cart[key].id_product}> add </button>`
        out += `</div>`
    }
    fullCart.innerHTML = out;
    let a = d.querySelectorAll('.addOneMoreToCart'),i;
    for (i = 0 ; i < a.length; i++) {
        let x = a[i];
        x.addEventListener('click', addOneMoreToCart);
    }

    let minus = d.querySelectorAll('.deleteFromCart'),b;
    for (b = 0 ; b < minus.length; b++) {
        let q = minus[b];
        q.addEventListener('click', deleteFromCart);
    }
}
function deleteFromCart () {
    var articule = this.getAttribute('dataminus')
    cart[articule].count--;
    if (cart[articule].count == 0) {
        delete cart[articule] 
    }
    localStorage.setItem('cart', JSON.stringify(cart));
    renderCart()
}

function addOneMoreToCart () {
    var articule = this.getAttribute('data')
    cart[articule].count++;
    localStorage.setItem('cart', JSON.stringify(cart));
    renderCart()
}

	
function removeCart(){
	cart = {};
	localStorage.setItem('cart', JSON.stringify(cart));
	d.querySelector('.fullCart').innerHTML = '';
}

function CheckLocalStorage(){
    if (localStorage.getItem('cart') != null) {
    	cart = JSON.parse(localStorage.getItem('cart'));
    	showGoodsInCart();
    }
};

const list = new GoodsList();
list.fetchGoods()
CheckLocalStorage();



























  /*add() {
  	this.goods.push(good);
  	this.render();              FOR FOOD
  }*/

 /* remove() {
  	const goodIndex = this.goods.findIndex(item => item.title == good.title);
  	this.goods.splice(goodIndex, 1);	
  	this.render()				FOR FOOD
  }*/
</script>

</html>



